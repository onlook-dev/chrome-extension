!function(){"use strict";const n=(n,t)=>window.fetch(n,t);let t=0,e=new Map;async function r(r,a={}){try{return await n(r,{cache:"force-cache",referrer:a.referrer,headers:a.headers})}catch(n){t++;const i=new Promise(((n,r)=>e.set(t,{resolve:n,reject:r})));return await c({method:"singlefile.fetch",url:r,requestId:t,referrer:a.referrer,headers:a.headers}),i}}async function a(n,t){const e=await c({method:"singlefile.fetchFrame",url:n,frameId:t.frameId,referrer:t.referrer,headers:t.headers});return{status:e.status,headers:new Map(e.headers),arrayBuffer:async()=>new Uint8Array(e.array).buffer}}async function c(n){const t=await browser.runtime.sendMessage(n);if(!t||t.error)throw new Error(t&&t.error&&t.error.toString());return t}browser.runtime.onMessage.addListener((t=>"singlefile.fetchFrame"==t.method&&window.frameId&&window.frameId==t.frameId?async function(t){try{const e=await n(t.url,{cache:"force-cache",headers:t.headers});return{status:e.status,headers:[...e.headers],array:Array.from(new Uint8Array(await e.arrayBuffer()))}}catch(n){return{error:n&&n.toString()}}}(t):"singlefile.fetchResponse"==t.method?async function(n){const t=e.get(n.requestId);t&&(n.error?(t.reject(new Error(n.error)),e.delete(n.requestId)):(n.truncated&&(t.array?t.array=t.array.concat(n.array):(t.array=n.array,e.set(n.requestId,t)),n.finished&&(n.array=t.array)),n.truncated&&!n.finished||(t.resolve({status:n.status,headers:{get:t=>n.headers&&n.headers[t]},arrayBuffer:async()=>new Uint8Array(n.array).buffer}),e.delete(n.requestId))));return{}}(t):void 0));const i=0,s=[i],o=Symbol(),u=new TextEncoder,f=new TextDecoder,w=new Array(256);let y=0;function l(n,t,e,r){if(void 0===r){if(y++,!(w.length-y>=s.length))throw new Error("Reached maximum number of custom types");w[w.length-y]={serialize:n,parse:t,test:e}}else w[r]={serialize:n,parse:t,test:e}}async function h(n){const t=function(){let n,t,e,r,a,c;return{next:async n=>n?i(n):{value:await r,done:!0},return:()=>({done:!0})};async function i(n){return a?await a:s().catch((()=>{})),u(),e(n),{done:!1}}async function s(){let t;r=new Promise((n=>t=n)),n=new j(f),o();const e=await O(n);n.executeSetters(),t(e)}function o(){t=new Promise((n=>e=n))}function u(){a=new Promise((n=>c=n))}async function f(){const n=await t;return o(),c&&c(),n}}();await t.next(n);return(await t.next()).value}async function d(n,t){const e=w.findIndex((({test:e}={})=>e&&e(t,n)));n.addObject(t),await n.append(new Uint8Array([e]));const r=w[e].serialize;r&&await r(n,t),e!=i&&B(t)&&(await async function(n,t){const e=Object.getOwnPropertySymbols(t),r=e.map((n=>[n,t[n]]));await m(n,r)}(n,t),await async function(n,t){if(ArrayBuffer.isView(t))await d(n,0);else{let e=Object.entries(t);N(t)&&(e=e.filter((([n])=>!D(Number(n))))),await d(n,e.length);for(const[t,r]of e)await b(n,t),await d(n,r)}}(n,t))}async function m(n,t){await d(n,t.length);const e=Object.keys(t).filter((n=>D(Number(n)))).map((n=>Number(n)));let r=0,a=e[r];for(const[c,i]of t.entries())a==c?(a=e[++r],await d(n,i)):await d(n,o)}async function b(n,t){const e=u.encode(t);await d(n,e.length),await n.append(e)}async function g(n,t){await d(n,t.length),await n.append("Uint8Array"==t.constructor.name?t:new Uint8Array(t.buffer))}async function p(n,t){const e=new Uint8Array(new Float64Array([t]).buffer);await n.append(e)}async function A(n,t){const e=new Uint8Array([Number(t)]);await n.append(e)}l((async function(n,t){const e=n.objects.indexOf(t);await d(n,e)}),(async function(n){const t=await O(n);return new U(t,n)}),(function(n,t){return B(n)&&t.objects.includes(n)}),i),l(null,(function(){return{}}),B),l(m,v,N),l(b,R,(function(n){return"string"==typeof n})),l(g,(async function(n){const t=await O(n),e=await n.consume(8*t);return new Float64Array(e.buffer)}),(function(n){return"Float64Array"==n.constructor.name})),l(g,(async function(n){const t=await O(n),e=await n.consume(4*t);return new Float32Array(e.buffer)}),(function(n){return"Float32Array"==n.constructor.name})),l(g,(async function(n){const t=await O(n),e=await n.consume(4*t);return new Uint32Array(e.buffer)}),(function(n){return"Uint32Array"==n.constructor.name})),l(g,(async function(n){const t=await O(n),e=await n.consume(4*t);return new Int32Array(e.buffer)}),(function(n){return"Int32Array"==n.constructor.name})),l(g,(async function(n){const t=await O(n),e=await n.consume(2*t);return new Uint16Array(e.buffer)}),(function(n){return"Uint16Array"==n.constructor.name})),l(g,(async function(n){const t=await O(n),e=await n.consume(2*t);return new Int16Array(e.buffer)}),(function(n){return"Int16Array"==n.constructor.name})),l(g,(async function(n){const t=await O(n),e=await n.consume(t);return new Uint8ClampedArray(e.buffer)}),(function(n){return"Uint8ClampedArray"==n.constructor.name})),l(g,(async function(n){const t=await O(n);return await n.consume(t)}),(function(n){return"Uint8Array"==n.constructor.name})),l(g,(async function(n){const t=await O(n),e=await n.consume(t);return new Int8Array(e.buffer)}),(function(n){return"Int8Array"==n.constructor.name})),l((async function(n,t){await d(n,t.byteLength),await n.append(new Uint8Array(t))}),(async function(n){const t=await O(n);return(await n.consume(t)).buffer}),(function(n){return"ArrayBuffer"==n.constructor.name})),l(p,L,F),l((async function(n,t){const e=new Uint8Array(new Uint32Array([t]).buffer);await n.append(e)}),(async function(n){const t=await n.consume(4);return new Uint32Array(t.buffer)[0]}),(function(n){return D(n)&&n>=0&&n<=4294967295})),l((async function(n,t){const e=new Uint8Array(new Int32Array([t]).buffer);await n.append(e)}),(async function(n){const t=await n.consume(4);return new Int32Array(t.buffer)[0]}),(function(n){return D(n)&&n>=-2147483648&&n<=2147483647})),l((async function(n,t){const e=new Uint8Array(new Uint16Array([t]).buffer);await n.append(e)}),(async function(n){const t=await n.consume(2);return new Uint16Array(t.buffer)[0]}),(function(n){return D(n)&&n>=0&&n<=65535})),l((async function(n,t){const e=new Uint8Array(new Int16Array([t]).buffer);await n.append(e)}),(async function(n){const t=await n.consume(2);return new Int16Array(t.buffer)[0]}),(function(n){return D(n)&&n>=-32768&&n<=32767})),l((async function(n,t){const e=new Uint8Array([t]);await n.append(e)}),(async function(n){const t=await n.consume(1);return new Uint8Array(t.buffer)[0]}),(function(n){return D(n)&&n>=0&&n<=255})),l((async function(n,t){const e=new Uint8Array(new Int8Array([t]).buffer);await n.append(e)}),(async function(n){const t=await n.consume(1);return new Int8Array(t.buffer)[0]}),(function(n){return D(n)&&n>=-128&&n<=127})),l(null,(function(){return}),(function(n){return void 0===n})),l(null,(function(){return null}),(function(n){return null===n})),l(null,(function(){return NaN}),(function(n){return Number.isNaN(n)})),l(A,x,(function(n){return"boolean"==typeof n})),l((async function(n,t){await b(n,t.description)}),(async function(n){const t=await R(n);return Symbol(t)}),P),l(null,(function(){return o}),S),l((async function(n,t){const e=t.entries();await d(n,t.size);for(const[t,r]of e)await d(n,t),await d(n,r)}),(async function(n){const t=await O(n),e=new Map;t&&await async function r(a=0){const c=await O(n),i=await O(n);n.setObject([c,i],((n,t)=>e.set(n,t))),a<t-1&&await r(a+1)}();return e}),(function(n){return n instanceof Map})),l((async function(n,t){await d(n,t.size);for(const e of t)await d(n,e)}),(async function(n){const t=await O(n),e=new Set;t&&await async function r(a=0){const c=await O(n);n.setObject([c],(n=>e.add(n))),a<t-1&&await r(a+1)}();return e}),(function(n){return n instanceof Set})),l((async function(n,t){await p(n,t.getTime())}),(async function(n){const t=await L(n);return new Date(t)}),(function(n){return n instanceof Date})),l((async function(n,t){await b(n,t.message),await b(n,t.stack)}),(async function(n){const t=await R(n),e=await R(n),r=new Error(t);return r.stack=e,r}),(function(n){return n instanceof Error})),l((async function(n,t){await b(n,t.source),await b(n,t.flags)}),(async function(n){const t=await R(n),e=await R(n);return new RegExp(t,e)}),(function(n){return n instanceof RegExp})),l((async function(n,t){await b(n,t.valueOf())}),(async function(n){return new String(await R(n))}),(function(n){return n instanceof String})),l((async function(n,t){await p(n,t.valueOf())}),(async function(n){return new Number(await L(n))}),(function(n){return n instanceof Number})),l((async function(n,t){await A(n,t.valueOf())}),(async function(n){return new Boolean(await x(n))}),(function(n){return n instanceof Boolean}));class U{constructor(n,t){this.index=n,this.data=t}getObject(){return this.data.objects[this.index]}}class j{constructor(n){this.stream=new I(n),this.objects=[],this.setters=[]}consume(n){return this.stream.consume(n)}getObjectId(){const n=this.objects.length;return this.objects.push(void 0),n}resolveObject(n,t){(function(n){return B(n)||P(n)})(t)&&!E(t)&&(this.objects[n]=t)}setObject(n,t){this.setters.push({functionArguments:n,setterFunction:t})}executeSetters(){this.setters.forEach((({functionArguments:n,setterFunction:t})=>{t(...n.map((n=>E(n)?n.getObject():n)))}))}}class I{constructor(n){this.offset=0,this.value=new Uint8Array(0),this.consumeData=n}async consume(n){if(this.offset+n>this.value.length){const t=this.value.subarray(this.offset,this.value.length),e=await this.consumeData();return t.length+e.length!=this.value.length&&(this.value=new Uint8Array(t.length+e.length)),this.value.set(t),this.value.set(e,t.length),this.offset=0,this.consume(n)}{const t=this.value.slice(this.offset,this.offset+n);return this.offset+=t.length,t}}}async function O(n){const t=(await n.consume(1))[0],e=w[t].parse,r=n.getObjectId(),a=await e(n);return t!=i&&B(a)&&(await async function(n,t){const e=await v(n);n.setObject([e],(n=>n.forEach((([n,e])=>t[n]=e))))}(n,a),await async function(n,t){const e=await O(n);e&&await r();async function r(a=0){const c=await R(n),i=await O(n);n.setObject([i],(n=>t[c]=n)),a<e-1&&await r(a+1)}}(n,a)),n.resolveObject(r,a),a}async function v(n){const t=await O(n),e=new Array(t);return t&&await async function r(a=0){const c=await O(n);S(c)||n.setObject([c],(n=>e[a]=n));a<t-1&&await r(a+1)}(),e}async function R(n){const t=await O(n),e=await n.consume(t);return f.decode(e)}async function L(n){const t=await n.consume(8);return new Float64Array(t.buffer)[0]}async function x(n){const t=await n.consume(1);return Boolean(t[0])}function E(n){return n instanceof U}function B(n){return n===Object(n)}function N(n){return"number"==typeof n.length}function S(n){return n===o}function F(n){return"number"==typeof n}function D(n){return F(n)&&Number.isInteger(n)}function P(n){return"symbol"==typeof n}function T(n,t={}){return new Promise(((e,r)=>{const a=new XMLHttpRequest;if(a.withCredentials=!0,a.responseType="arraybuffer",a.onerror=n=>r(new Error(n.detail)),a.onreadystatechange=()=>{a.readyState==XMLHttpRequest.DONE&&e({status:a.status,headers:{get:n=>a.getResponseHeader(n)},arrayBuffer:async()=>a.response})},a.open("GET",n,!0),t.headers)for(const n of Object.entries(t.headers))a.setRequestHeader(n[0],n[1]);a.send()}))}browser.runtime.onMessage.addListener((async({method:n,pageData:t,url:e,data:c,options:i,width:s,height:o})=>{if("processPage"==n){const n=await function(n,t,e,c={fetch:r,frameFetch:a}){return globalThis.singlefile.getPageData(n,c,t,e)}(i,null,null,{fetch:T}),e=new Blob(["string"==typeof n.content?n.content:new Uint8Array(n.content)],{type:t.mimeType});return{url:URL.createObjectURL(e),archiveTime:n.archiveTime,doctype:n.doctype,filename:n.filename,title:n.title}}if("compressPage"==n){const n=await function(n,t){return globalThis.singlefile.processors.compression.process(n,t)}(await h(t),i);return{url:URL.createObjectURL(n)}}if("getBlobURL"==n)return{url:URL.createObjectURL(new Blob([new Uint8Array(c)]))};if("revokeObjectURL"==n)return URL.revokeObjectURL(e),{};if("getImageData"==n){const n=new Image;await new Promise(((t,r)=>{n.onload=t,n.onerror=n=>r(new Error(n.detail)),n.src=e}));const t=document.createElement("canvas");t.width=s,t.height=o;const r=t.getContext("2d");r.drawImage(n,0,0,s,o);const{data:a}=await r.getImageData(0,0,s,o);return{url:URL.createObjectURL(new Blob([a]))}}}))}();
